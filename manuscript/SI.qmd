---
format:
    html:
      self-contained: true
title: Supporting Information
execute:
  echo: false
bibliography: bibliography.bib
csl: science-advances.csl
editor: 
  markdown: 
    wrap: sentence
---

```{r}
#| label: set-up
#| echo: false
#| message: false
library(targets)
library(tarchetypes)
library(tidyverse)
library(lubridate)
library(broom)
library(gt)
library(piecewiseSEM)
library(patchwork)
library(ggpubr)
```

## Methods

### Supplementary Figure S1: Temperature effects on the microclimate

```{r}
#| label: fig-daily-climate
#| warning: false
#| fig-cap: a) Daily temperature and soil moisture values, measured over the period of the experiment in the alpine and sub-alpine sites and b) average summer temperature and soil moisture between May and September. Shown are air (30 cm), ground (0 cm), soil temperature (-5 cm), and soil moisture measured with Tomst loggers between August 2019 and October 2022. Colour indicates the ambient (grey) and warming (red) treatment. Air, ground and soil temperature were higher and soil moisture was lower in the warming treatment, indicated by the star in each panel.

tar_load(daily_climate_figure)
daily_climate_figure

```

### Supplementary Figure S2: Plant productivity and consumption

```{r}
#| label: fig-prod-consumption 
#| warning: false
#| fig-height: 4
#| fig-cap: Annual productivity (mg m^-2^ y^-1^) and biomass consumption (mg m^-2^ y^-1) at the three study sites. Colors indicate grazed (yellow) and ungrazed (caged; gray) plots. Productivity and biomass consumption by grazers was assessed using three 30 x 30 cm cages (ungrazed) and according control plots (grazed). The cages were designed to exclude mammal herbivores, but not insects, with a mesh size of 1 cm. The plots were moved every 15.5 ± 0.447 days, and the biomass in each plot was harvested 2-3 cm above the ground, dried at 65°C for 72h and weighed. 

tar_load(productivity_consumption_figure)
productivity_consumption_figure

```

### Supplementary Table S1: Temperature effects on the microclimate

```{r}
#| label: tbl-climate-test
#| tbl-cap: Results from linear regression of the effects of warming on air, ground, and soil temperature and soilmoisture at the alpine and sub-alpine communities. Shown are estimates, standard error, t statistics and P value.


tar_load(microclimate_stats)
microclimate_stats

```

### Supplementary Figure S3: Climate and global change drivers

```{r}
#| label: fig-climate
#| warning: false
#| fig-cap: Global change impact on microclimate. Average summer (June - September) air, ground soil temperature and soil moisture between 2019 and 2022 with increasing nitrogen addition (kg N ha^-1^ y^-1^) at the alpine (upper row) and sub-alpine (lower row) site. The x axis is log transformed, the numbers are on the original scale for ease of interpretation. The colors indicate ambient (gray) and warm conditions (pink) and the shapes show the different grazing treatments (circle = control, square = medium, triangle = intensive grazing). The points show the raw data, while the lines indicate model predictions with confidence intervals. The capital letters within panels indicate significant model terms (W = warming).
tar_load(climate_figure)
climate_figure
```

### Supplementary Table S2: Climate and global change drivers

```{r}
#| label: tbl-climate
#| tbl-cap: Anova table of the effects of warming, nitrogen addition, grazing, and their interactions on air, ground and soil temperature and soilmoisture at the alpine and sub-alpine communities. Shown are sum of Squares, degrees of freedom (df), F statistics and P value. Significant terms (P < 0.05) are in bold.

tar_load(climate_stats)
climate_stats

```

### Supplementary Figure S4: Calculating standing biomass

```{r}
#| label: fig-bio-calc-coll
#| echo: false
#| warning: false
#| fig-cap: Relationship between collected and estimated standing biomass in the control plots. Standing biomass is estimated from the community data using *sum of cover x vegetation height*. This estimated biomass is then backtransformed to actual biomass using the biomass collected at peak growing season in the control plots


tar_read(standing_biomass_back_fig)

```

### Supplementary Table S3: Model output for estimated standing biomass

```{r}
#| label: tbl-standing-biomass-model-output
#| echo: false
#| warning: false
#| tbl-cap: Model output for the relationship between estimated and collected standing biomass.

tar_load(standing_biomass_model)


tidy(standing_biomass_model) |> 
  mutate(term = case_match(term,
                           "(Intercept)" ~ "Intercept",
                           "biomass_remaining_calc" ~ "Biomass",
                           "Nitrogen_log" ~ "Log(Nitrogen)")) |>  
  select("Term" = term, "Estimate" = estimate, `Std. Error` = std.error, `t value` = statistic, `P value` = p.value) |>
  gt() |> 
  gt::fmt_number(columns = c(Estimate, `Std. Error`, `t value`), decimals = 2) |> 
  gt::fmt_number(columns = c(`P value`), decimals = 3) |> 
  tab_style(
    style = list(
      cell_text(weight = "bold")
      ),
    locations = cells_column_labels(columns = c(Term, Estimate, `Std. Error`, `t value`, `P value`))
    )

```

### Supplementary Table S4: Model output for biomass and diversity models
```{r}
#| label: tbl-biomass-diversity-model-output
#| echo: false
#| warning: false
#| tbl-cap: Model output for the relationship between the global change drivers and standing biomass or the diversity indices. Shown are sum of squares, degrees of freedom (df), F statistics and P value. Significant terms (P < 0.05) are in bold.

tar_load(biomass_origin_anova_table)
tar_load(diversity_origin_anova_table)

# Combine the tables
biomass_origin_anova_table |>
  mutate(variable = "Standing biomass") |>
  bind_rows(
    diversity_origin_anova_table |>
      mutate(variable = case_match(diversity_index,
                                   "diversity" ~ "Shannon diversity",
                                   "richness" ~ "Species richness",
                                   "evenness" ~ "Evenness"))
  ) |>
  # Sort variables in desired order
  mutate(variable = factor(variable, levels = c("Standing biomass", "Shannon diversity", "Species richness", "Evenness"))) |>
  # Round values
  mutate(
    sumsq = round(sumsq, 2),
    statistic = round(statistic, 2),
    p.value = if_else(p.value < 0.001, "< 0.001", as.character(round(p.value, 3)))
  ) |>
  # Pivot to wide format to put Alpine and Sub-alpine side by side
  select(variable, origSiteID, term, sumsq, df, statistic, p.value) |>
  pivot_wider(
    names_from = origSiteID,
    values_from = c(sumsq, df, statistic, p.value),
    names_glue = "{origSiteID}_{.value}"
  ) |>
  # Rename columns
  rename(
    "Term" = term,
    "Alpine_Sum of squares" = Alpine_sumsq,
    "Alpine_df" = Alpine_df,
    "Alpine_F" = Alpine_statistic,
    "Alpine_P" = Alpine_p.value,
    "Sub-alpine_Sum of squares" = `Sub-alpine_sumsq`,
    "Sub-alpine_df" = `Sub-alpine_df`,
    "Sub-alpine_F" = `Sub-alpine_statistic`,
    "Sub-alpine_P" = `Sub-alpine_p.value`
  ) |>
  # Reorder columns to put Alpine first
  select(variable, Term, 
         "Alpine_Sum of squares", "Alpine_df", "Alpine_F", "Alpine_P",
         "Sub-alpine_Sum of squares", "Sub-alpine_df", "Sub-alpine_F", "Sub-alpine_P") |>
  # Sort by variable in desired order
  arrange(variable) |>
  # Group by variable
  group_by(variable) |>
  gt() |>
  # Add column spanners for Alpine and Sub-alpine
  tab_spanner(
    label = "Alpine",
    columns = c("Alpine_Sum of squares", "Alpine_df", "Alpine_F", "Alpine_P")
  ) |>
  tab_spanner(
    label = "Sub-alpine", 
    columns = c("Sub-alpine_Sum of squares", "Sub-alpine_df", "Sub-alpine_F", "Sub-alpine_P")
  ) |>
  # Format numbers
  fmt_number(columns = c("Alpine_Sum of squares", "Alpine_F", "Sub-alpine_Sum of squares", "Sub-alpine_F"), decimals = 2) |>
  fmt_number(columns = c("Alpine_df", "Sub-alpine_df"), decimals = 0) |>
  # Make term column always bold
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = "Term")
  ) |>
  # Make Alpine significant values bold
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(
      columns = c("Alpine_Sum of squares", "Alpine_df", "Alpine_F", "Alpine_P"),
      rows = Alpine_P != "< 0.001" & as.numeric(Alpine_P) <= 0.05
    )
  ) |>
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(
      columns = c("Alpine_Sum of squares", "Alpine_df", "Alpine_F", "Alpine_P"),
      rows = Alpine_P == "< 0.001"
    )
  ) |>
  # Make Sub-alpine significant values bold
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(
      columns = c("Sub-alpine_Sum of squares", "Sub-alpine_df", "Sub-alpine_F", "Sub-alpine_P"),
      rows = `Sub-alpine_P` != "< 0.001" & as.numeric(`Sub-alpine_P`) <= 0.05
    )
  ) |>
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(
      columns = c("Sub-alpine_Sum of squares", "Sub-alpine_df", "Sub-alpine_F", "Sub-alpine_P"),
      rows = `Sub-alpine_P` == "< 0.001"
    )
  ) |>
  # Rename columns at the end to remove prefixes
  cols_label(
    "Alpine_Sum of squares" = "Sum of squares",
    "Alpine_df" = "df",
    "Alpine_F" = "F",
    "Alpine_P" = "P",
    "Sub-alpine_Sum of squares" = "Sum of squares",
    "Sub-alpine_df" = "df",
    "Sub-alpine_F" = "F",
    "Sub-alpine_P" = "P"
  ) |>
  # Set column alignment
  cols_align(
    align = "left",
    columns = "Term"
  ) |>
  cols_align(
    align = "right",
    columns = c("Alpine_Sum of squares", "Alpine_df", "Alpine_F", "Alpine_P",
                "Sub-alpine_Sum of squares", "Sub-alpine_df", "Sub-alpine_F", "Sub-alpine_P")
  )

```

### Supplementary Figure S5: Global change affects richness and evenness

```{r}
#| label: fig-div-index
#| echo: false
#| warning: false
#| fig-width: 8
#| fig-height: 7
#| fig-cap: Species richness (a) and evenness (b) with increasing nitrogen addition (kg N ha^-1^ y^-1^) in the alpine (upper row) and sub-alpine (lower row) sites. The x axis is log transformed, the numbers are on the original scale for ease of interpretation. The colors indicate ambient (grey) and warm conditions (red) and the shapes show the different clipping treatments (circle = control, square = medium, triangle = intensive clipping). The points show the raw data, while the lines indicate model predictions with confidence intervals. The capital letters within panels indicate significant (black) model terms (W = warming, N = nitrogen addition, C = clipping, S = site, combined letters, e.g. WxC = interactions). Letters in grey indicate almost significant model terms (0.05 > *P* < 0.07).

tar_read(div_index_figure)

```

### Structural equation models

#### Supplementary Table S5: Stats for final cut diversity

```{r}
#| label: tbl-cut-final-stats
#| echo: false
#| message: false
#| fig-width: 10
#| fig-height: 10
#| tbl-cap: SEM output for direct effects of warming, nitrogen addition, and cutting and indirect effects via standing biomass on Shannon diversity. Shown are the response, predictors, standard estimate, standard error, degrees of freedome and P value. Variables in bold have a significant P value.

tar_load(cut_final_diversity)

cut_final_diversity[[2]] |> 
  select(Type:Predictor, Std.Estimate, Std.Error, DF, P.Value) |> 
  mutate(Std.Estimate = round(Std.Estimate, 2),
           Std.Error = round(Std.Error, 2),
           P.Value = if_else(P.Value <= 0.001, "≤ 0.001", as.character(round(P.Value, 3)))) |> 
  group_by(Type) |> 
  gt() |> 
  tab_style(
      style = list(
        cell_text(weight = "bold")
      ),
      locations = cells_body(
        columns = c(Response, Predictor, Std.Estimate, Std.Error, DF, P.Value),
        rows = P.Value <= 0.05
      )) |> 
  tab_style(
    style = list(
      cell_text(weight = "bold")
      ),
    locations = cells_column_labels(columns = c(Response, Predictor, Std.Estimate, Std.Error, DF, P.Value))
    )

```

#### SEM for species richness and evenness

```{r}
#| label: fig-cut-final-rich-even
#| echo: false
#| message: false
#| fig-width: 10
#| fig-height: 10
#| fig-cap: "Structural equation model showing the direct effects of the global change drivers, warming, nitrogen addition and cutting and indirectly through biomass on species richness and evenness for the a) and c) alpine and b) and d) sub-alpine site. The numbers indicate the regression coefficients and the thickness of the line relates to the strength of the effect. The linetype and colours shows the strength and direction of the effect (solid coloured = positive and significant, dashed coloured = negative and significant, and dot-dashed grey = negative and non-significant). Each driver, mediator and predictor are coloured in a separate colour: red = warming, dark green = nitrogen, yellow = clipping, light green = biomass, grey = diversity."

tar_load(cut_final_richness_evenness)

cut_final_richness_evenness[[1]]

```

#### SEMs for natural grazing

```{r}
#| label: fig-graz-final-all-diversity
#| echo: false
#| message: false
#| fig-width: 10
#| fig-height: 15
#| fig-cap: Structural equation model showing the direct effects of the global change drivers, warming, nitrogen addition and grazing and indirectly through biomass on diversity, richness, and evenness for the alpine (a, c, e) and the sub-alpine site (b, d, f). The numbers indicate the regression coefficients, the linetype shows the strength (solid = significant, dashed = non-significant), and the colour the direction of the effect (blue = positive, red = negative). 

tar_load(graz_final_all_div)

graz_final_all_div[[1]]

```
